#!/bin/bash

# exit on failure
set -e

AGENT_INDEX=$1
PUBLIC_IP=$2
AGENT_PORT=$3

if ! hash java 2>/dev/null; then
  echo "java not found"
  exit 1
fi

if command -v killall >/dev/null 2>&1; then
  killall -9 -q java || true
elif command -v pkill >/dev/null 2>&1; then
  pkill -9 java || true
else
  echo "killall/pkill not found; skipping java cleanup"
fi

rm -f agent.pid
rm -f agent.out
rm -f agent.err

echo "Agent [${AGENT_INDEX}] ${PUBLIC_IP} starting"

args="--addressIndex ${AGENT_INDEX} --publicAddress ${PUBLIC_IP} --port $AGENT_PORT"
nohup hazelcast-simulator/bin/hidden/agent $args > agent.out 2> agent.err < /dev/null &
hazelcast-simulator/bin/hidden/await_file_exists agent.pid

echo "Agent [A$AGENT_INDEX] ${PUBLIC_IP} started successfully"
